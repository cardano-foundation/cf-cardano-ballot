<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">voting-app</a> &gt; <a href="index.source.html" class="el_package">org.cardano.foundation.voting.service.auth.jwt</a> &gt; <span class="el_source">JwtService.java</span></div><h1>JwtService.java</h1><pre class="source lang-java linenums">package org.cardano.foundation.voting.service.auth.jwt;

import com.nimbusds.jose.JOSEException;
import com.nimbusds.jose.JWSHeader;
import com.nimbusds.jose.crypto.Ed25519Signer;
import com.nimbusds.jose.crypto.Ed25519Verifier;
import com.nimbusds.jose.jwk.OctetKeyPair;
import com.nimbusds.jwt.JWTClaimsSet;
import com.nimbusds.jwt.SignedJWT;
import io.micrometer.core.annotation.Timed;
import io.vavr.control.Either;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import lombok.val;
import org.cardano.foundation.voting.domain.ChainNetwork;
import org.cardano.foundation.voting.domain.LoginResult;
import org.cardano.foundation.voting.domain.Role;
import org.cardano.foundation.voting.domain.web3.WalletType;
import org.cardano.foundation.voting.utils.Addresses;
import org.cardano.foundation.voting.utils.Enums;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.zalando.problem.Problem;

import java.text.ParseException;
import java.time.Clock;
import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.UUID;

import static com.nimbusds.jose.JWSAlgorithm.EdDSA;
import static org.cardano.foundation.voting.utils.MoreTime.convertToDateViaInstant;
import static org.zalando.problem.Status.*;

<span class="fc" id="L35">@RequiredArgsConstructor</span>
@Service
<span class="fc" id="L37">@Slf4j</span>
public class JwtService {

    private final OctetKeyPair cfJWTKey;

    private final Clock clock;

    private final ChainNetwork chainNetworkStartedOn;

    @Value(&quot;${cardano.jwt.iss}&quot;)
    private String iss;

    @Value(&quot;${cardano.jwt.tokenValidityDurationHours}&quot;)
    private long tokenValidityDurationHours;

    @Timed(value = &quot;service.jwt.generate&quot;, histogram = true)
    public Either&lt;Problem, LoginResult&gt; generate(WalletType walletType,
                                                 String walletId,
                                                 String eventId,
                                                 Role role) {
<span class="fc" id="L57">        val now = LocalDateTime.now(clock);</span>

        try {
<span class="fc" id="L60">            val signer = new Ed25519Signer(cfJWTKey);</span>
<span class="fc" id="L61">            val expirationLocalDateTime = now.plusHours(tokenValidityDurationHours);</span>
<span class="fc" id="L62">            val legacyExpirationDate = convertToDateViaInstant(expirationLocalDateTime);</span>

<span class="fc" id="L64">            val claimsSet = new JWTClaimsSet.Builder()</span>
<span class="fc" id="L65">                    .subject(walletId)</span>
<span class="fc" id="L66">                    .jwtID(UUID.randomUUID().toString())</span>
<span class="fc" id="L67">                    .issuer(iss)</span>
<span class="fc" id="L68">                    .claim(&quot;walletType&quot;, walletType.name())</span>
<span class="fc" id="L69">                    .claim(&quot;walletId&quot;, walletId)</span>
<span class="fc" id="L70">                    .claim(&quot;eventId&quot;, eventId)</span>
<span class="fc" id="L71">                    .claim(&quot;role&quot;, role)</span>
<span class="fc" id="L72">                    .claim(&quot;network&quot;, chainNetworkStartedOn.name())</span>
<span class="fc" id="L73">                    .issueTime(convertToDateViaInstant(now))</span>
<span class="fc" id="L74">                    .expirationTime(legacyExpirationDate)</span>
<span class="fc" id="L75">                    .build();</span>

<span class="fc" id="L77">            val header = new JWSHeader.Builder(EdDSA)</span>
<span class="fc" id="L78">                    .keyID(cfJWTKey.getKeyID())</span>
<span class="fc" id="L79">                    .build();</span>

<span class="fc" id="L81">            val signedJWT = new SignedJWT(header, claimsSet);</span>

<span class="fc" id="L83">            signedJWT.sign(signer);</span>

<span class="fc" id="L85">            val accessToken = signedJWT.serialize();</span>

<span class="fc" id="L87">            return Either.right(new LoginResult(accessToken, walletType, expirationLocalDateTime));</span>
<span class="nc" id="L88">        } catch (JOSEException e) {</span>
<span class="nc" id="L89">            log.error(&quot;JWT token generation error&quot;, e);</span>

<span class="nc" id="L91">            return Either.left(Problem.builder()</span>
<span class="nc" id="L92">                    .withTitle(&quot;JWT_GENERATION_FAILED&quot;)</span>
<span class="nc" id="L93">                    .withDetail(e.getMessage())</span>
<span class="nc" id="L94">                    .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L95">                    .build());</span>
        }
    }

    @Timed(value = &quot;service.jwt.verify&quot;, histogram = true)
    public Either&lt;Problem, SignedJWT&gt; verify(String token) {
<span class="fc" id="L101">        val publicJWK = cfJWTKey.toPublicJWK();</span>

        try {
<span class="fc" id="L104">            val verifier = new Ed25519Verifier(publicJWK);</span>
<span class="fc" id="L105">            val signedJWT = SignedJWT.parse(token);</span>

<span class="pc bpc" id="L107" title="1 of 2 branches missed.">            if (signedJWT.verify(verifier)) {</span>
<span class="fc" id="L108">                val jwtClaimsSet = signedJWT.getJWTClaimsSet();</span>
<span class="fc" id="L109">                val sub = jwtClaimsSet.getSubject();</span>

<span class="fc" id="L111">                val issuerCheck = jwtClaimsSet.getIssuer().equals(iss);</span>

<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                if (!issuerCheck) {</span>
<span class="nc" id="L114">                    log.warn(&quot;JWT token verification failed for token:{}, issuer check failed.&quot;, token);</span>

<span class="nc" id="L116">                    return Either.left(</span>
<span class="nc" id="L117">                            Problem.builder()</span>
<span class="nc" id="L118">                                    .withTitle(&quot;JWT_ISSUER_MISMATCH&quot;)</span>
<span class="nc" id="L119">                                    .withDetail(&quot;JWT verification failed for token:&quot; + token + &quot; due to issuer check failed.&quot;)</span>
<span class="nc" id="L120">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L121">                                    .build()</span>
                    );
                }

<span class="fc" id="L125">                val now = LocalDateTime.now(clock);</span>
<span class="fc" id="L126">                val nowDate = convertToDateViaInstant(now);</span>
<span class="fc" id="L127">                val expDate = signedJWT.getJWTClaimsSet().getExpirationTime();</span>

<span class="pc bpc" id="L129" title="1 of 2 branches missed.">                if (nowDate.after(expDate)) {</span>
<span class="nc" id="L130">                    log.info(&quot;JWT token verification failed for token, token expired on: {}&quot;, expDate);</span>

<span class="nc" id="L132">                    return Either.left(</span>
<span class="nc" id="L133">                            Problem.builder()</span>
<span class="nc" id="L134">                                    .withTitle(&quot;JWT_EXPIRED&quot;)</span>
<span class="nc" id="L135">                                    .withDetail(&quot;JWT verification failed for token, token expired on: &quot; + expDate)</span>
<span class="nc" id="L136">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L137">                                    .build());</span>
                }

<span class="fc" id="L140">                val jwtChainNetwork = jwtClaimsSet.getStringClaim(&quot;network&quot;);</span>
<span class="fc" id="L141">                val networkM = Enums.getIfPresent(ChainNetwork.class, jwtChainNetwork);</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">                if (networkM.isEmpty()) {</span>
<span class="nc" id="L143">                    log.warn(&quot;Invalid network, network:{}&quot;, jwtChainNetwork);</span>

<span class="nc" id="L145">                    return Either.left(Problem.builder()</span>
<span class="nc" id="L146">                            .withTitle(&quot;INVALID_NETWORK&quot;)</span>
<span class="nc" id="L147">                            .withDetail(&quot;Invalid network, supported networks: &quot; + ChainNetwork.supportedNetworks())</span>
<span class="nc" id="L148">                            .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L149">                            .build());</span>
                }

<span class="fc" id="L152">                val jwtNetwork = networkM.orElseThrow();</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">                if (jwtNetwork != chainNetworkStartedOn) {</span>
<span class="nc" id="L154">                    log.warn(&quot;Network mismatch, network:{}&quot;, jwtNetwork);</span>

<span class="nc" id="L156">                    return Either.left(Problem.builder()</span>
<span class="nc" id="L157">                            .withTitle(&quot;NETWORK_MISMATCH&quot;)</span>
<span class="nc" id="L158">                            .withDetail(&quot;Invalid network, backend configured with network: &quot; + chainNetworkStartedOn + &quot;, however request is with network: &quot; + jwtNetwork)</span>
<span class="nc" id="L159">                            .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L160">                            .build());</span>

                }

<span class="fc" id="L164">                val walletId = jwtClaimsSet.getStringClaim(&quot;walletId&quot;);</span>
<span class="fc" id="L165">                val walletTypeM = Enums.getIfPresent(WalletType.class, jwtClaimsSet.getStringClaim(&quot;walletType&quot;));</span>

<span class="pc bpc" id="L167" title="1 of 2 branches missed.">                if (walletTypeM.isEmpty()) {</span>
<span class="nc" id="L168">                    log.warn(&quot;Invalid wallet type, walletType:{}&quot;, jwtClaimsSet.getStringClaim(&quot;walletType&quot;));</span>

<span class="nc" id="L170">                    return Either.left(Problem.builder()</span>
<span class="nc" id="L171">                            .withTitle(&quot;INVALID_WALLET_TYPE&quot;)</span>
<span class="nc" id="L172">                            .withDetail(&quot;Invalid wallet type, supported wallet types:&quot; + Arrays.asList(WalletType.values()))</span>
<span class="nc" id="L173">                            .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L174">                            .build());</span>
                }

<span class="fc" id="L177">                val walletType = walletTypeM.orElseThrow();</span>
<span class="fc" id="L178">                val walletIdCheck = Addresses.checkWalletId(chainNetworkStartedOn, walletType, walletId);</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">                if (walletIdCheck.isEmpty()) {</span>
<span class="nc" id="L180">                    return Either.left(walletIdCheck.getLeft());</span>
                }

<span class="fc" id="L183">                val roleM = Enums.getIfPresent(Role.class, jwtClaimsSet.getStringClaim(&quot;role&quot;));</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">                if (roleM.isEmpty()) {</span>
<span class="nc" id="L185">                    log.warn(&quot;Invalid role, role:{}&quot;, jwtClaimsSet.getStringClaim(&quot;role&quot;));</span>

<span class="nc" id="L187">                    return Either.left(Problem.builder()</span>
<span class="nc" id="L188">                            .withTitle(&quot;INVALID_ROLE&quot;)</span>
<span class="nc" id="L189">                            .withDetail(&quot;Invalid role, supported roles:&quot; + Role.supportedRoles())</span>
<span class="nc" id="L190">                            .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L191">                            .build());</span>
                }

<span class="fc" id="L194">                log.info(&quot;Verified sub:{}, &quot;, sub);</span>

<span class="fc" id="L196">                return Either.right(signedJWT);</span>
            }

<span class="nc" id="L199">            log.error(&quot;JWT token verification failed for token:{}, signature verification failed.&quot;, token);</span>

<span class="nc" id="L201">            return Either.left(</span>
<span class="nc" id="L202">                    Problem.builder()</span>
<span class="nc" id="L203">                            .withTitle(&quot;JWT_VERIFICATION_FAILED&quot;)</span>
<span class="nc" id="L204">                            .withDetail(&quot;JWT verification failed for token:&quot; + token)</span>
<span class="nc" id="L205">                            .withStatus(UNAUTHORIZED)</span>
<span class="nc" id="L206">                            .build()</span>
            );
<span class="nc" id="L208">        } catch (JOSEException e) {</span>
<span class="nc" id="L209">            log.warn(&quot;JWT token verification error&quot;, e);</span>

<span class="nc" id="L211">            return Either.left(</span>
<span class="nc" id="L212">                    Problem.builder()</span>
<span class="nc" id="L213">                            .withTitle(&quot;JWT_VERIFICATION_FAILED&quot;)</span>
<span class="nc" id="L214">                            .withDetail(&quot;JWT verification failed for token:&quot; + token)</span>
<span class="nc" id="L215">                            .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L216">                            .build()</span>
            );
<span class="nc" id="L218">        } catch (ParseException e) {</span>
<span class="nc" id="L219">            log.warn(&quot;JWT token parse error, reason:{}&quot;, e.getMessage());</span>

<span class="nc" id="L221">            return Either.left(</span>
<span class="nc" id="L222">                    Problem.builder()</span>
<span class="nc" id="L223">                            .withTitle(&quot;JWT_VERIFICATION_FAILED&quot;)</span>
<span class="nc" id="L224">                            .withDetail(&quot;JWT verification failed for token:&quot; + token)</span>
<span class="nc" id="L225">                            .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L226">                            .build()</span>
            );
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>