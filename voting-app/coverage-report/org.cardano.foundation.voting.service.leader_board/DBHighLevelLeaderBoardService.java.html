<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DBHighLevelLeaderBoardService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">voting-app</a> &gt; <a href="index.source.html" class="el_package">org.cardano.foundation.voting.service.leader_board</a> &gt; <span class="el_source">DBHighLevelLeaderBoardService.java</span></div><h1>DBHighLevelLeaderBoardService.java</h1><pre class="source lang-java linenums">package org.cardano.foundation.voting.service.leader_board;

import com.google.common.collect.Iterables;
import io.vavr.control.Either;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.cardano.foundation.voting.client.ChainFollowerClient;
import org.cardano.foundation.voting.domain.Leaderboard;
import org.cardano.foundation.voting.repository.VoteRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.zalando.problem.Problem;

import java.util.ArrayList;
import java.util.Optional;

import static java.util.stream.Collectors.toMap;
import static org.zalando.problem.Status.*;

@Service
<span class="fc" id="L21">@Slf4j</span>
<span class="fc" id="L22">@RequiredArgsConstructor</span>
public class DBHighLevelLeaderBoardService implements HighLevelLeaderBoardService {

    private final ChainFollowerClient chainFollowerClient;

    private final VoteRepository voteRepository;

    @Override
    @Transactional(readOnly = true)
    public Either&lt;Problem, Boolean&gt; isHighLevelEventLeaderboardAvailable(String event,
                                                                         boolean forceLeaderboard) {
<span class="fc" id="L33">        var eventDetailsE = chainFollowerClient.getEventDetails(event);</span>
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">        if (eventDetailsE.isEmpty()) {</span>
<span class="nc" id="L35">            return Either.left(Problem.builder()</span>
<span class="nc" id="L36">                    .withTitle(&quot;ERROR_GETTING_EVENT_DETAILS&quot;)</span>
<span class="nc" id="L37">                    .withDetail(&quot;Unable to get event details from chain-tip follower service, event:&quot; + event)</span>
<span class="nc" id="L38">                    .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L39">                    .build()</span>
            );
        }
<span class="fc" id="L42">        var maybeEventDetails = eventDetailsE.get();</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">        if (maybeEventDetails.isEmpty()) {</span>
<span class="nc" id="L44">            return Either.left(Problem.builder()</span>
<span class="nc" id="L45">                    .withTitle(&quot;UNRECOGNISED_EVENT&quot;)</span>
<span class="nc" id="L46">                    .withDetail(&quot;Unrecognised event, event:&quot; + event)</span>
<span class="nc" id="L47">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L48">                    .build()</span>
            );
        }
<span class="fc" id="L51">        var eventDetails = maybeEventDetails.orElseThrow();</span>

<span class="fc" id="L53">        return isHighLevelEventLeaderboardAvailable(eventDetails, forceLeaderboard);</span>
    }

    @Override
    @Transactional(readOnly = true)
    public Either&lt;Problem, Boolean&gt; isHighLevelCategoryLeaderboardAvailable(String event, boolean forceLeaderboard) {
<span class="nc" id="L59">        var eventDetailsE = chainFollowerClient.getEventDetails(event);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (eventDetailsE.isEmpty()) {</span>
<span class="nc" id="L61">            return Either.left(Problem.builder()</span>
<span class="nc" id="L62">                    .withTitle(&quot;ERROR_GETTING_EVENT_DETAILS&quot;)</span>
<span class="nc" id="L63">                    .withDetail(&quot;Unable to get event details from chain-tip follower service, event:&quot; + event)</span>
<span class="nc" id="L64">                    .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L65">                    .build()</span>
            );
        }
<span class="nc" id="L68">        var maybeEventDetails = eventDetailsE.get();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (maybeEventDetails.isEmpty()) {</span>
<span class="nc" id="L70">            return Either.left(Problem.builder()</span>
<span class="nc" id="L71">                    .withTitle(&quot;UNRECOGNISED_EVENT&quot;)</span>
<span class="nc" id="L72">                    .withDetail(&quot;Unrecognised event, event:&quot; + event)</span>
<span class="nc" id="L73">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L74">                    .build()</span>
            );
        }
<span class="nc" id="L77">        var eventDetails = maybeEventDetails.orElseThrow();</span>

<span class="nc" id="L79">        return isHighLevelCategoryLeaderboardAvailable(eventDetails, forceLeaderboard);</span>
    }

    @Override
    @Transactional(readOnly = true)
    public Either&lt;Problem, Leaderboard.ByEventStats&gt; getEventLeaderboard(String event, boolean forceLeaderboard) {
<span class="fc" id="L85">        var eventDetailsE = chainFollowerClient.getEventDetails(event);</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">        if (eventDetailsE.isEmpty()) {</span>
<span class="nc" id="L87">            return Either.left(Problem.builder()</span>
<span class="nc" id="L88">                    .withTitle(&quot;ERROR_GETTING_EVENT_DETAILS&quot;)</span>
<span class="nc" id="L89">                    .withDetail(&quot;Unable to get event details from chain-tip follower service, event:&quot; + event)</span>
<span class="nc" id="L90">                    .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L91">                    .build()</span>
            );
        }
<span class="fc" id="L94">        var maybeEventDetails = eventDetailsE.get();</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">        if (maybeEventDetails.isEmpty()) {</span>
<span class="nc" id="L96">            return Either.left(Problem.builder()</span>
<span class="nc" id="L97">                    .withTitle(&quot;UNRECOGNISED_EVENT&quot;)</span>
<span class="nc" id="L98">                    .withDetail(&quot;Unrecognised event, event:&quot; + event)</span>
<span class="nc" id="L99">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L100">                    .build()</span>
            );
        }
<span class="fc" id="L103">        var eventDetails = maybeEventDetails.orElseThrow();</span>

<span class="fc" id="L105">        var highLevelEventLeaderboardAvailableE = isHighLevelEventLeaderboardAvailable(eventDetails, forceLeaderboard);</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">        if (highLevelEventLeaderboardAvailableE.isEmpty()) {</span>
<span class="nc" id="L107">            return Either.left(highLevelEventLeaderboardAvailableE.getLeft());</span>
        }
<span class="fc" id="L109">        var isHighLevelEventLeaderBoardAvailable = highLevelEventLeaderboardAvailableE.get();</span>

<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        if (!isHighLevelEventLeaderBoardAvailable) {</span>
<span class="nc" id="L112">            return Either.left(Problem.builder()</span>
<span class="nc" id="L113">                    .withTitle(&quot;VOTING_RESULTS_NOT_AVAILABLE&quot;)</span>
<span class="nc" id="L114">                    .withDetail(&quot;Event level voting results not available until voting event finishes!&quot;)</span>
<span class="nc" id="L115">                    .withStatus(FORBIDDEN)</span>
<span class="nc" id="L116">                    .build()</span>
            );
        }

<span class="fc" id="L120">        var votes = voteRepository.getHighLevelEventStats(event);</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        if (votes.isEmpty()) {</span>
<span class="nc" id="L122">            Leaderboard.ByEventStats.ByEventStatsBuilder byEventStatsBuilder = Leaderboard.ByEventStats.builder()</span>
<span class="nc" id="L123">                    .event(eventDetails.id())</span>
<span class="nc" id="L124">                    .totalVotesCount(0L);</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">            switch (eventDetails.votingEventType()) {</span>
<span class="nc" id="L127">                case BALANCE_BASED, STAKE_BASED -&gt; byEventStatsBuilder.totalVotingPower(&quot;0&quot;);</span>
            }

<span class="nc" id="L130">            return Either.right(byEventStatsBuilder</span>
<span class="nc" id="L131">                    .build());</span>
        }

<span class="fc" id="L134">        var eventVoteCount = Iterables.getOnlyElement(votes);</span>
<span class="fc" id="L135">        var voteCount = eventVoteCount.getTotalVoteCount();</span>

<span class="fc" id="L137">        var byEventStatsBuilder = Leaderboard.ByEventStats.builder()</span>
<span class="fc" id="L138">                .event(eventDetails.id())</span>
<span class="fc" id="L139">                .totalVotesCount(Optional.ofNullable(voteCount).orElse(0L));</span>

<span class="fc" id="L141">        var votingPower = eventVoteCount.getTotalVotingPower();</span>

<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        switch (eventDetails.votingEventType()) {</span>
            case BALANCE_BASED, STAKE_BASED -&gt;
<span class="fc" id="L145">                    byEventStatsBuilder.totalVotingPower(Optional.ofNullable(votingPower).map(String::valueOf).orElse(&quot;0&quot;));</span>
        }

<span class="fc" id="L148">        var eventLeaderboardAvailableE = isHighLevelCategoryLeaderboardAvailable(eventDetails, forceLeaderboard);</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">        if (eventLeaderboardAvailableE.isEmpty()) {</span>
<span class="nc" id="L150">            return Either.left(eventLeaderboardAvailableE.getLeft());</span>
        }
<span class="fc" id="L152">        var isEventLeaderBoardAvailable = eventLeaderboardAvailableE.get();</span>

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (!isEventLeaderBoardAvailable) {</span>
<span class="nc" id="L155">            return Either.right(byEventStatsBuilder.build());</span>
        }

<span class="fc" id="L158">        var allHighLevelCategoryStats = voteRepository.getHighLevelCategoryLevelStats(event);</span>

<span class="fc" id="L160">        var byCategoryStats = allHighLevelCategoryStats.stream()</span>
<span class="fc" id="L161">                .map(categoryLevelStats -&gt; {</span>
<span class="fc" id="L162">                    var byCategoryStatsBuilder = Leaderboard.ByCategoryStats.builder();</span>

<span class="fc" id="L164">                    byCategoryStatsBuilder.id(categoryLevelStats.getCategoryId());</span>
<span class="fc" id="L165">                    byCategoryStatsBuilder.votes(Optional.ofNullable(categoryLevelStats.getTotalVoteCount()).orElse(0L));</span>

<span class="pc bpc" id="L167" title="1 of 2 branches missed.">                    switch (eventDetails.votingEventType()) {</span>
                        case BALANCE_BASED, STAKE_BASED -&gt; {
<span class="fc" id="L169">                            var votingPowerM = Optional.ofNullable(categoryLevelStats.getTotalVotingPower())</span>
<span class="fc" id="L170">                                    .map(String::valueOf)</span>
<span class="fc" id="L171">                                    .orElse(&quot;0&quot;);</span>

<span class="fc" id="L173">                            byCategoryStatsBuilder.votingPower(votingPowerM);</span>
                        }
                    }

<span class="fc" id="L177">                    return byCategoryStatsBuilder.build();</span>
                })
<span class="fc" id="L179">                .toList();</span>

<span class="fc" id="L181">        var byCategoryStatsMap = byCategoryStats.stream()</span>
<span class="fc" id="L182">                .collect(toMap(Leaderboard.ByCategoryStats::getId, stats -&gt; stats));</span>

<span class="fc" id="L184">        var byCategoryStatsCopy = new ArrayList&lt;&gt;(byCategoryStats);</span>
        // pre init with empty if category not returned from db

<span class="fc" id="L187">        eventDetails.categories().forEach(categoryDetails -&gt; {</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">            if (!byCategoryStatsMap.containsKey(categoryDetails.id())) {</span>
<span class="nc" id="L189">                var b = Leaderboard.ByCategoryStats.builder();</span>
<span class="nc" id="L190">                b.id(categoryDetails.id());</span>

<span class="nc" id="L192">                b.votes(0L);</span>

<span class="nc bnc" id="L194" title="All 2 branches missed.">                switch (eventDetails.votingEventType()) {</span>
<span class="nc" id="L195">                    case BALANCE_BASED, STAKE_BASED -&gt; b.votingPower(&quot;0&quot;);</span>
                }

<span class="nc" id="L198">                byCategoryStatsCopy.add(b.build());</span>
            }
<span class="fc" id="L200">        });</span>

<span class="fc" id="L202">        byEventStatsBuilder.categories(byCategoryStatsCopy);</span>

<span class="fc" id="L204">        return Either.right(byEventStatsBuilder.build());</span>
    }


    private Either&lt;Problem, Boolean&gt; isHighLevelEventLeaderboardAvailable(ChainFollowerClient.EventDetailsResponse eventDetails,
                                                                          boolean forceLeaderboard) {
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (forceLeaderboard) {</span>
<span class="nc" id="L211">            return Either.right(true);</span>
        }

<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if (eventDetails.highLevelEventResultsWhileVoting()) {</span>
<span class="fc" id="L215">            return Either.right(true);</span>
        }

<span class="nc" id="L218">        return Either.right(eventDetails.proposalsReveal());</span>
    }

    private Either&lt;Problem, Boolean&gt; isHighLevelCategoryLeaderboardAvailable(ChainFollowerClient.EventDetailsResponse eventDetails,
                                                                             boolean forceLeaderboard) {
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">        if (forceLeaderboard) {</span>
<span class="nc" id="L224">            return Either.right(true);</span>
        }

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (eventDetails.highLevelCategoryResultsWhileVoting()) {</span>
<span class="fc" id="L228">            return Either.right(true);</span>
        }

<span class="nc" id="L231">        return Either.right(eventDetails.proposalsReveal());</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>