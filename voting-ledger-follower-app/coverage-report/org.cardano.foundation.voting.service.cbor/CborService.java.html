<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CborService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">voting-ledger-follower-app</a> &gt; <a href="index.source.html" class="el_package">org.cardano.foundation.voting.service.cbor</a> &gt; <span class="el_source">CborService.java</span></div><h1>CborService.java</h1><pre class="source lang-java linenums">package org.cardano.foundation.voting.service.cbor;

import com.bloxbean.cardano.client.metadata.cbor.CBORMetadataList;
import com.bloxbean.cardano.client.metadata.cbor.CBORMetadataMap;
import io.vavr.control.Either;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.cardano.foundation.voting.domain.OnChainEventType;
import org.cardano.foundation.voting.domain.SchemaVersion;
import org.cardano.foundation.voting.domain.VotingEventType;
import org.cardano.foundation.voting.domain.VotingPowerAsset;
import org.cardano.foundation.voting.domain.entity.Tally.TallyType;
import org.cardano.foundation.voting.domain.web3.*;
import org.cardano.foundation.voting.utils.Enums;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.zalando.problem.Problem;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import static org.cardano.foundation.voting.domain.OnChainEventType.COMMITMENTS;
import static org.cardano.foundation.voting.domain.OnChainEventType.EVENT_REGISTRATION;
import static org.cardano.foundation.voting.domain.SchemaVersion.V11;
import static org.cardano.foundation.voting.domain.VotingEventType.*;
import static org.cardano.foundation.voting.domain.entity.Tally.TallyType.HYDRA;
import static org.cardano.foundation.voting.utils.ChunkedMetadataParser.deChunk;
import static org.cardano.foundation.voting.utils.MoreBoolean.fromBigInteger;
import static org.zalando.problem.Status.BAD_REQUEST;
import static org.zalando.problem.Status.INTERNAL_SERVER_ERROR;

@Service
<span class="fc" id="L35">@Slf4j</span>
@RequiredArgsConstructor
public class CborService {

    @Value(&quot;${cardano.snapshot.bounds.check.enabled:true}&quot;)
    private boolean isSnapshotBoundCheck;

    public Either&lt;Problem, CommitmentsEnvelope&gt; decodeCommitmentsEnvelope(CBORMetadataMap payload) {
        try {
<span class="nc" id="L44">            var maybeOnchainEventType = Enums.getIfPresent(OnChainEventType.class, (String) payload.get(&quot;type&quot;));</span>

<span class="nc bnc" id="L46" title="All 4 branches missed.">            if (maybeOnchainEventType.isEmpty() || maybeOnchainEventType.orElseThrow() != COMMITMENTS) {</span>
<span class="nc" id="L47">                return Either.left(</span>
<span class="nc" id="L48">                        Problem.builder()</span>
<span class="nc" id="L49">                                .withTitle(&quot;INVALID_COMMITMENTS&quot;)</span>
<span class="nc" id="L50">                                .withDetail(&quot;Invalid commitments event, missing type field.&quot;)</span>
<span class="nc" id="L51">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L52">                                .build());</span>
            }

<span class="nc" id="L55">            var maybeCreationSlot = Optional.ofNullable(payload.get(&quot;creationSlot&quot;)).map(obj -&gt; ((BigInteger) obj).longValue());</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">            if (maybeCreationSlot.isEmpty()) {</span>
<span class="nc" id="L57">                return Either.left(</span>
<span class="nc" id="L58">                        Problem.builder()</span>
<span class="nc" id="L59">                                .withTitle(&quot;INVALID_COMMITMENTS_EVENT&quot;)</span>
<span class="nc" id="L60">                                .withDetail(&quot;Invalid commitments event, missing creationSlot field.&quot;)</span>
<span class="nc" id="L61">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L62">                                .build());</span>
            }

<span class="nc" id="L65">            var maybeCommitments = Optional.ofNullable(payload.get(&quot;commitments&quot;)).map(obj -&gt; (CBORMetadataMap) obj);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            if (maybeCommitments.isEmpty()) {</span>
<span class="nc" id="L67">                return Either.left(</span>
<span class="nc" id="L68">                        Problem.builder()</span>
<span class="nc" id="L69">                                .withTitle(&quot;INVALID_COMMITMENTS_EVENT&quot;)</span>
<span class="nc" id="L70">                                .withDetail(&quot;Invalid category registration event, missing actual commitments field.&quot;)</span>
<span class="nc" id="L71">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L72">                                .build());</span>
            }

<span class="nc" id="L75">            var commitments = maybeCommitments.orElseThrow();</span>

<span class="nc" id="L77">            var commitmentsEnvelope = CommitmentsEnvelope.builder()</span>
<span class="nc" id="L78">                    .type(maybeOnchainEventType.orElseThrow())</span>
<span class="nc" id="L79">                    .creationSlot(maybeCreationSlot.orElseThrow())</span>
<span class="nc" id="L80">                    .schemaVersion((String) payload.get(&quot;schemaVersion&quot;))</span>
<span class="nc" id="L81">                    .build();</span>

<span class="nc bnc" id="L83" title="All 2 branches missed.">            for (Object eventId : commitments.keys()) {</span>
<span class="nc" id="L84">                var commitmentMap = (CBORMetadataMap) commitments.get((String) eventId);</span>
<span class="nc" id="L85">                var commitmentHash = (String) commitmentMap.get(&quot;hash&quot;);</span>
<span class="nc" id="L86">                commitmentsEnvelope.addCommitment((String) eventId, commitmentHash);</span>
<span class="nc" id="L87">            }</span>

<span class="nc" id="L89">            return Either.right(commitmentsEnvelope);</span>
<span class="nc" id="L90">        } catch (Exception e) {</span>
<span class="nc" id="L91">            return Either.left(</span>
<span class="nc" id="L92">                    Problem.builder()</span>
<span class="nc" id="L93">                            .withTitle(&quot;INVALID_COMMITMENTS_EVENT&quot;)</span>
<span class="nc" id="L94">                            .withDetail(&quot;Invalid commitments event&quot;)</span>
<span class="nc" id="L95">                            .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L96">                            .withDetail(e.getMessage())</span>
<span class="nc" id="L97">                            .build()</span>
            );
        }
    }

    public Either&lt;Problem, CategoryRegistrationEnvelope&gt; decodeCategoryRegistrationEnvelope(CBORMetadataMap payload) {
        try {
<span class="nc" id="L104">            var maybeOnchainEventType = Enums.getIfPresent(OnChainEventType.class, (String) payload.get(&quot;type&quot;));</span>

<span class="nc bnc" id="L106" title="All 4 branches missed.">            if (maybeOnchainEventType.isEmpty() || maybeOnchainEventType.orElseThrow() != OnChainEventType.CATEGORY_REGISTRATION) {</span>
<span class="nc" id="L107">                return Either.left(</span>
<span class="nc" id="L108">                        Problem.builder()</span>
<span class="nc" id="L109">                                .withTitle(&quot;INVALID_CATEGORY_REGISTRATION&quot;)</span>
<span class="nc" id="L110">                                .withDetail(&quot;Invalid category event, missing type field.&quot;)</span>
<span class="nc" id="L111">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L112">                                .build());</span>
            }

<span class="nc" id="L115">            var maybeName = Optional.ofNullable((String) payload.get(&quot;id&quot;));</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (maybeName.isEmpty()) {</span>
<span class="nc" id="L117">                return Either.left(</span>
<span class="nc" id="L118">                        Problem.builder()</span>
<span class="nc" id="L119">                                .withTitle(&quot;INVALID_CATEGORY_REGISTRATION&quot;)</span>
<span class="nc" id="L120">                                .withDetail(&quot;Invalid category registration event, missing name field.&quot;)</span>
<span class="nc" id="L121">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L122">                                .build());</span>
            }
<span class="nc" id="L124">            log.info(&quot;Category registration event name:{}&quot;, maybeName.orElseThrow());</span>

<span class="nc" id="L126">            var maybeEvent = Optional.ofNullable((String) payload.get(&quot;event&quot;));</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (maybeEvent.isEmpty()) {</span>
<span class="nc" id="L128">                return Either.left(</span>
<span class="nc" id="L129">                        Problem.builder()</span>
<span class="nc" id="L130">                                .withTitle(&quot;INVALID_CATEGORY_REGISTRATION&quot;)</span>
<span class="nc" id="L131">                                .withDetail(&quot;Invalid category registration event, missing event field.&quot;)</span>
<span class="nc" id="L132">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L133">                                .build());</span>
            }

<span class="nc" id="L136">            var maybeCreationSlot = Optional.ofNullable(payload.get(&quot;creationSlot&quot;)).map(obj -&gt; ((BigInteger) obj).longValue());</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (maybeCreationSlot.isEmpty()) {</span>
<span class="nc" id="L138">                return Either.left(</span>
<span class="nc" id="L139">                        Problem.builder()</span>
<span class="nc" id="L140">                                .withTitle(&quot;INVALID_CATEGORY_REGISTRATION&quot;)</span>
<span class="nc" id="L141">                                .withDetail(&quot;Invalid category registration event, missing creationSlot field.&quot;)</span>
<span class="nc" id="L142">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L143">                                .build());</span>
            }

<span class="nc" id="L146">            var maybeOptions = Optional.ofNullable(payload.get(&quot;options&quot;)).map(obj -&gt; (CBORMetadataMap) obj);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (maybeOptions.isEmpty()) {</span>
<span class="nc" id="L148">                return Either.left(</span>
<span class="nc" id="L149">                        Problem.builder()</span>
<span class="nc" id="L150">                                .withTitle(&quot;INVALID_CATEGORY_REGISTRATION&quot;)</span>
<span class="nc" id="L151">                                .withDetail(&quot;Invalid category registration event, missing options field.&quot;)</span>
<span class="nc" id="L152">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L153">                                .build());</span>
            }
<span class="nc" id="L155">            var options = maybeOptions.orElseThrow();</span>

<span class="nc" id="L157">            var maybeProposals = Optional.ofNullable(payload.get(&quot;proposals&quot;)).map(obj -&gt; (CBORMetadataList) obj);</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">            if (maybeProposals.isEmpty() || maybeProposals.orElseThrow().size() == 0) {</span>
<span class="nc" id="L159">                return Either.left(</span>
<span class="nc" id="L160">                        Problem.builder()</span>
<span class="nc" id="L161">                                .withTitle(&quot;INVALID_CATEGORY_REGISTRATION&quot;)</span>
<span class="nc" id="L162">                                .withDetail(&quot;Invalid category registration event, missing proposals field.&quot;)</span>
<span class="nc" id="L163">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L164">                                .build());</span>
            }

<span class="nc" id="L167">            boolean isGdprProtection = fromBigInteger((BigInteger) options.get(&quot;gdprProtection&quot;)).orElse(false);</span>

<span class="nc" id="L169">            var schemaVersion = SchemaVersion.fromText((String) payload.get(&quot;schemaVersion&quot;));</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (schemaVersion.isEmpty()) {</span>
<span class="nc" id="L172">                return Either.left(</span>
<span class="nc" id="L173">                        Problem.builder()</span>
<span class="nc" id="L174">                                .withTitle(&quot;INVALID_CATEGORY_REGISTRATION&quot;)</span>
<span class="nc" id="L175">                                .withDetail(&quot;Invalid category registration event, missing or unrecognised schemaVersion field.&quot;)</span>
<span class="nc" id="L176">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L177">                                .build());</span>
            }

<span class="nc" id="L180">            var categoryRegistration = CategoryRegistrationEnvelope.builder()</span>
<span class="nc" id="L181">                    .type(maybeOnchainEventType.orElseThrow())</span>
<span class="nc" id="L182">                    .id(maybeName.orElseThrow())</span>
<span class="nc" id="L183">                    .event(maybeEvent.orElseThrow())</span>
<span class="nc" id="L184">                    .creationSlot(maybeCreationSlot.orElseThrow())</span>
<span class="nc" id="L185">                    .gdprProtection(isGdprProtection)</span>
<span class="nc" id="L186">                    .proposals(readProposalsEnvelope(maybeProposals.orElseThrow(), isGdprProtection))</span>
<span class="nc" id="L187">                    .schemaVersion(schemaVersion.orElseThrow())</span>
<span class="nc" id="L188">                    .build();</span>

<span class="nc" id="L190">            return Either.right(categoryRegistration);</span>
<span class="nc" id="L191">        } catch (Exception e) {</span>
<span class="nc" id="L192">            return Either.left(</span>
<span class="nc" id="L193">                    Problem.builder()</span>
<span class="nc" id="L194">                            .withTitle(&quot;INVALID_CATEGORY_EVENT&quot;)</span>
<span class="nc" id="L195">                            .withDetail(&quot;Invalid category event&quot;)</span>
<span class="nc" id="L196">                            .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L197">                            .withDetail(e.getMessage())</span>
<span class="nc" id="L198">                            .build()</span>
            );
        }
    }

    public Either&lt;Problem, EventRegistrationEnvelope&gt; decodeEventRegistrationEnvelope(CBORMetadataMap payload) {
        try {
<span class="nc" id="L205">            String name = (String) payload.get(&quot;id&quot;);</span>

<span class="nc" id="L207">            var maybeOnchainEventType = Enums.getIfPresent(OnChainEventType.class, (String) payload.get(&quot;type&quot;));</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">            if (maybeOnchainEventType.isEmpty() || maybeOnchainEventType.orElseThrow() != EVENT_REGISTRATION) {</span>
<span class="nc" id="L209">                return Either.left(</span>
<span class="nc" id="L210">                        Problem.builder()</span>
<span class="nc" id="L211">                                .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L212">                                .withDetail(&quot;Invalid event registration event, missing type field.&quot;)</span>
<span class="nc" id="L213">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L214">                                .build());</span>
            }

<span class="nc" id="L217">            var maybeOrganisers = Optional.ofNullable((String)payload.get(&quot;organisers&quot;));</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (maybeOrganisers.isEmpty()) {</span>
<span class="nc" id="L219">                return Either.left(</span>
<span class="nc" id="L220">                        Problem.builder()</span>
<span class="nc" id="L221">                                .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L222">                                .withDetail(&quot;Invalid event registration event, missing organisers field.&quot;)</span>
<span class="nc" id="L223">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L224">                                .build());</span>
            }

<span class="nc" id="L227">            var maybeCreationSlot = Optional.ofNullable(payload.get(&quot;creationSlot&quot;)).map(obj -&gt; ((BigInteger) obj).longValue());</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (maybeCreationSlot.isEmpty()) {</span>
<span class="nc" id="L229">                return Either.left(</span>
<span class="nc" id="L230">                        Problem.builder()</span>
<span class="nc" id="L231">                                .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L232">                                .withDetail(&quot;Invalid event registration event, missing creationSlot field.&quot;)</span>
<span class="nc" id="L233">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L234">                                .build());</span>
            }

<span class="nc" id="L237">            var maybeVotingEventType = Enums.getIfPresent(VotingEventType.class, (String) payload.get(&quot;votingEventType&quot;));</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">            if (maybeVotingEventType.isEmpty()) {</span>
<span class="nc" id="L239">                return Either.left(</span>
<span class="nc" id="L240">                        Problem.builder()</span>
<span class="nc" id="L241">                                .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L242">                                .withDetail(&quot;Invalid event registration event, missing votingEventType field.&quot;)</span>
<span class="nc" id="L243">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L244">                                .build());</span>
            }

<span class="nc" id="L247">            var votingEventType = maybeVotingEventType.orElseThrow();</span>

<span class="nc" id="L249">            var maybeVotingPowerAsset = Enums.getIfPresent(VotingPowerAsset.class, (String) payload.get(&quot;votingPowerAsset&quot;));</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (List.of(STAKE_BASED, BALANCE_BASED).contains(votingEventType)) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                if (maybeVotingPowerAsset.isEmpty()) {</span>
<span class="nc" id="L252">                    return Either.left(</span>
<span class="nc" id="L253">                            Problem.builder()</span>
<span class="nc" id="L254">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L255">                                    .withDetail(&quot;Invalid event registration event, missing votingPowerAsset field.&quot;)</span>
<span class="nc" id="L256">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L257">                                    .build());</span>
                }
            }

<span class="nc" id="L261">            var eventRegistrationEnvelopeBuilder = EventRegistrationEnvelope.builder()</span>
<span class="nc" id="L262">                    .name(name)</span>
<span class="nc" id="L263">                    .type(EVENT_REGISTRATION)</span>
<span class="nc" id="L264">                    .organisers(maybeOrganisers.orElseThrow())</span>
<span class="nc" id="L265">                    .creationSlot(maybeCreationSlot.orElseThrow())</span>
<span class="nc" id="L266">                    .votingPowerAsset(maybeVotingPowerAsset)</span>
<span class="nc" id="L267">                    .votingEventType(votingEventType);</span>

<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (List.of(STAKE_BASED, BALANCE_BASED).contains(votingEventType)) {</span>
<span class="nc" id="L270">                var maybeStartEpoch = Optional.ofNullable(payload.get(&quot;startEpoch&quot;)).map(obj -&gt; ((BigInteger) obj).intValue());</span>

<span class="nc bnc" id="L272" title="All 2 branches missed.">                if (maybeStartEpoch.isEmpty()) {</span>
<span class="nc" id="L273">                    return Either.left(</span>
<span class="nc" id="L274">                            Problem.builder()</span>
<span class="nc" id="L275">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L276">                                    .withDetail(&quot;Invalid event registration event, missing startEpoch field.&quot;)</span>
<span class="nc" id="L277">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L278">                                    .build());</span>
                }
<span class="nc" id="L280">                var maybeEndEpoch = Optional.ofNullable(payload.get(&quot;endEpoch&quot;)).map(obj -&gt; ((BigInteger) obj).intValue());</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">                if (maybeEndEpoch.isEmpty()) {</span>
<span class="nc" id="L282">                    return Either.left(</span>
<span class="nc" id="L283">                            Problem.builder()</span>
<span class="nc" id="L284">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L285">                                    .withDetail(&quot;Invalid event registration event, missing endEpoch field.&quot;)</span>
<span class="nc" id="L286">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L287">                                    .build());</span>
                }

<span class="nc" id="L290">                var maybeSnapshotEpoch = Optional.ofNullable(payload.get(&quot;snapshotEpoch&quot;)).map(obj -&gt; ((BigInteger) obj).intValue());</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">                if (maybeSnapshotEpoch.isEmpty()) {</span>
<span class="nc" id="L292">                    return Either.left(</span>
<span class="nc" id="L293">                            Problem.builder()</span>
<span class="nc" id="L294">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L295">                                    .withDetail(&quot;Invalid event registration event, missing snapshotEpoch field.&quot;)</span>
<span class="nc" id="L296">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L297">                                    .build()</span>
                    );
                }

<span class="nc" id="L301">                var maybeProposalsRevealEpoch = Optional.ofNullable(payload.get(&quot;proposalsRevealEpoch&quot;)).map(obj -&gt; ((BigInteger) obj).intValue());</span>

<span class="nc bnc" id="L303" title="All 2 branches missed.">                if (maybeProposalsRevealEpoch.isEmpty()) {</span>
<span class="nc" id="L304">                    log.info(&quot;proposalsRevealEpoch for event:{} is not available, setting it to endEpoch&quot;, name);</span>

<span class="nc" id="L306">                    maybeProposalsRevealEpoch = Optional.of(maybeEndEpoch.orElseThrow());</span>
                } else {
<span class="nc" id="L308">                    log.info(&quot;proposalsRevealEpoch for event:{} is available, setting it to {}&quot;, name, maybeProposalsRevealEpoch.orElseThrow());</span>
                }

<span class="nc bnc" id="L311" title="All 2 branches missed.">                if (maybeStartEpoch.orElseThrow() &gt; maybeEndEpoch.orElseThrow()) {</span>
<span class="nc" id="L312">                    return Either.left(</span>
<span class="nc" id="L313">                            Problem.builder()</span>
<span class="nc" id="L314">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L315">                                    .withDetail(&quot;Invalid event registration event, startEpoch must be less than endEpoch.&quot;)</span>
<span class="nc" id="L316">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L317">                                    .build());</span>
                }

<span class="nc bnc" id="L320" title="All 2 branches missed.">                if (isSnapshotBoundCheck) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                    if (maybeSnapshotEpoch.orElseThrow() &gt;= maybeStartEpoch.orElseThrow()) {</span>
<span class="nc" id="L322">                        return Either.left(</span>
<span class="nc" id="L323">                                Problem.builder()</span>
<span class="nc" id="L324">                                        .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L325">                                        .withDetail(&quot;Invalid event registration event, snapshotEpoch must be before startEpoch.&quot;)</span>
<span class="nc" id="L326">                                        .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L327">                                        .build()</span>
                        );
                    }
                }

<span class="nc bnc" id="L332" title="All 2 branches missed.">                if (maybeProposalsRevealEpoch.orElseThrow() &lt; maybeEndEpoch.orElseThrow()) {</span>
<span class="nc" id="L333">                    return Either.left(</span>
<span class="nc" id="L334">                            Problem.builder()</span>
<span class="nc" id="L335">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L336">                                    .withDetail(&quot;Invalid event registration event, proposalsRevealEpoch must be greater than equal endEpoch.&quot;)</span>
<span class="nc" id="L337">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L338">                                    .build()</span>
                    );
                }

<span class="nc" id="L342">                eventRegistrationEnvelopeBuilder.startEpoch(maybeStartEpoch);</span>
<span class="nc" id="L343">                eventRegistrationEnvelopeBuilder.endEpoch(maybeEndEpoch);</span>
<span class="nc" id="L344">                eventRegistrationEnvelopeBuilder.snapshotEpoch(maybeSnapshotEpoch);</span>
<span class="nc" id="L345">                eventRegistrationEnvelopeBuilder.proposalsRevealEpoch(maybeProposalsRevealEpoch);</span>
            }

<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (votingEventType == USER_BASED) {</span>
<span class="nc" id="L349">                var maybeStartSlot = Optional.ofNullable(payload.get(&quot;startSlot&quot;)).map(obj -&gt; ((BigInteger) obj).longValue());</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                if (maybeStartSlot.isEmpty()) {</span>
<span class="nc" id="L351">                    return Either.left(</span>
<span class="nc" id="L352">                            Problem.builder()</span>
<span class="nc" id="L353">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L354">                                    .withDetail(&quot;Invalid event registration event, missing startSlot field.&quot;)</span>
<span class="nc" id="L355">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L356">                                    .build());</span>
                }
<span class="nc" id="L358">                var maybeEndSlot = Optional.ofNullable(payload.get(&quot;endSlot&quot;)).map(obj -&gt; ((BigInteger) obj).longValue());</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                if (maybeEndSlot.isEmpty()) {</span>
<span class="nc" id="L360">                    return Either.left(</span>
<span class="nc" id="L361">                            Problem.builder()</span>
<span class="nc" id="L362">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L363">                                    .withDetail(&quot;Invalid event registration event, missing endSlot field.&quot;)</span>
<span class="nc" id="L364">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L365">                                    .build());</span>
                }

<span class="nc" id="L368">                var maybeProposalsRevealSlot = Optional.ofNullable(payload.get(&quot;proposalsRevealSlot&quot;)).map(obj -&gt; ((BigInteger) obj).longValue());</span>

<span class="nc bnc" id="L370" title="All 2 branches missed.">                if (maybeProposalsRevealSlot.isEmpty()) {</span>
<span class="nc" id="L371">                    log.info(&quot;proposalsRevealSlot for event:{} is not available, setting it to endSlot&quot;, name);</span>

<span class="nc" id="L373">                    maybeProposalsRevealSlot = Optional.of(maybeEndSlot.orElseThrow());</span>
                } else {
<span class="nc" id="L375">                    log.info(&quot;proposalsRevealSlot for event:{} is available, setting it to {}&quot;, name, maybeProposalsRevealSlot.orElseThrow());</span>
                }

<span class="nc bnc" id="L378" title="All 2 branches missed.">                if (maybeEndSlot.orElseThrow() &lt; maybeStartSlot.orElseThrow()) {</span>
<span class="nc" id="L379">                    return Either.left(</span>
<span class="nc" id="L380">                            Problem.builder()</span>
<span class="nc" id="L381">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L382">                                    .withDetail(&quot;Invalid event registration event, startSlot must be less than endSlot.&quot;)</span>
<span class="nc" id="L383">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L384">                                    .build()</span>
                    );
                }

<span class="nc bnc" id="L388" title="All 2 branches missed.">                if (maybeProposalsRevealSlot.orElseThrow() &lt; maybeEndSlot.orElseThrow()) {</span>
<span class="nc" id="L389">                    return Either.left(</span>
<span class="nc" id="L390">                            Problem.builder()</span>
<span class="nc" id="L391">                                    .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L392">                                    .withDetail(&quot;Invalid event registration event, proposalsRevealSlot must be greater than equal endSlot.&quot;)</span>
<span class="nc" id="L393">                                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L394">                                    .build()</span>
                    );
                }

<span class="nc" id="L398">                eventRegistrationEnvelopeBuilder.startSlot(maybeStartSlot);</span>
<span class="nc" id="L399">                eventRegistrationEnvelopeBuilder.endSlot(maybeEndSlot);</span>
<span class="nc" id="L400">                eventRegistrationEnvelopeBuilder.proposalsRevealSlot(maybeProposalsRevealSlot);</span>
            }

<span class="nc" id="L403">            var maybeOptions = Optional.ofNullable((CBORMetadataMap) payload.get(&quot;options&quot;));</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (maybeOptions.isEmpty()) {</span>
<span class="nc" id="L405">                return Either.left(</span>
<span class="nc" id="L406">                        Problem.builder()</span>
<span class="nc" id="L407">                                .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L408">                                .withDetail(&quot;Invalid event registration event, missing options field.&quot;)</span>
<span class="nc" id="L409">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L410">                                .build());</span>
            }
<span class="nc" id="L412">            var options = maybeOptions.orElseThrow();</span>

<span class="nc" id="L414">            eventRegistrationEnvelopeBuilder.allowVoteChanging(fromBigInteger(((BigInteger)options.get(&quot;allowVoteChanging&quot;))).orElse(false));</span>

<span class="nc" id="L416">            eventRegistrationEnvelopeBuilder.highLevelEventResultsWhileVoting(fromBigInteger(((BigInteger)options.get(&quot;highLevelEventResultsWhileVoting&quot;))).orElse(false));</span>
<span class="nc" id="L417">            eventRegistrationEnvelopeBuilder.highLevelCategoryResultsWhileVoting(fromBigInteger(((BigInteger)options.get(&quot;highLevelCategoryResultsWhileVoting&quot;))).orElse(false));</span>
<span class="nc" id="L418">            eventRegistrationEnvelopeBuilder.categoryResultsWhileVoting(fromBigInteger(((BigInteger)options.get(&quot;categoryResultsWhileVoting&quot;))).orElse(false));</span>

<span class="nc" id="L420">            var schemaVersionM = SchemaVersion.fromText((String) payload.get(&quot;schemaVersion&quot;));</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">            if (schemaVersionM.isEmpty()) {</span>
<span class="nc" id="L422">                return Either.left(</span>
<span class="nc" id="L423">                        Problem.builder()</span>
<span class="nc" id="L424">                                .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L425">                                .withDetail(&quot;Invalid event registration event, missing or unsupported schemaVersion field.&quot;)</span>
<span class="nc" id="L426">                                .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L427">                                .build());</span>
            }

<span class="nc" id="L430">            var schemaVersion = schemaVersionM.orElseThrow();</span>

<span class="nc" id="L432">            eventRegistrationEnvelopeBuilder.schemaVersion(schemaVersion);</span>

<span class="nc bnc" id="L434" title="All 2 branches missed.">            if (schemaVersion.isGreaterThanEqual(V11)) {</span>
<span class="nc" id="L435">                var talliesM = Optional.ofNullable((CBORMetadataList) payload.get(&quot;tallies&quot;));</span>

<span class="nc bnc" id="L437" title="All 2 branches missed.">                if (talliesM.isPresent()) {</span>
<span class="nc" id="L438">                    var tallies = talliesM.orElseThrow();</span>

<span class="nc" id="L440">                    var tallyEnvelopeList = new ArrayList&lt;TallyRegistrationEnvelope&gt;();</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                    for (int i = 0; i &lt; tallies.size(); i++) {</span>
<span class="nc" id="L442">                        var tallyMap = (CBORMetadataMap) tallies.getValueAt(i);</span>

<span class="nc" id="L444">                        var tallyType = Enums.getIfPresent(TallyType.class, (String) tallyMap.get(&quot;type&quot;)).orElseThrow();</span>

<span class="nc" id="L446">                        var tallyEnvelopeBuilder = TallyRegistrationEnvelope.builder()</span>
<span class="nc" id="L447">                                .name((String) tallyMap.get(&quot;name&quot;))</span>
<span class="nc" id="L448">                                .description((String) tallyMap.get(&quot;description&quot;))</span>
<span class="nc" id="L449">                                .type(tallyType);</span>

<span class="nc bnc" id="L451" title="All 2 branches missed.">                        if (tallyType == HYDRA) {</span>
<span class="nc" id="L452">                            tallyEnvelopeBuilder.config(readHydraTallyEnvelope((CBORMetadataMap) tallyMap.get(&quot;config&quot;)));</span>
                        }

<span class="nc" id="L455">                        eventRegistrationEnvelopeBuilder.tallies(tallyEnvelopeList);</span>

<span class="nc" id="L457">                        tallyEnvelopeList.add(tallyEnvelopeBuilder.build());</span>
                    }
                }
            }

<span class="nc" id="L462">            return Either.right(eventRegistrationEnvelopeBuilder.build());</span>
<span class="nc" id="L463">        } catch (Exception e) {</span>
<span class="nc" id="L464">            return Either.left(</span>
<span class="nc" id="L465">                    Problem.builder()</span>
<span class="nc" id="L466">                            .withTitle(&quot;INVALID_EVENT_REGISTRATION&quot;)</span>
<span class="nc" id="L467">                            .withDetail(&quot;Invalid event registration event&quot;)</span>
<span class="nc" id="L468">                            .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L469">                            .withDetail(e.getMessage())</span>
<span class="nc" id="L470">                            .build());</span>

        }
    }

    private static List&lt;ProposalEnvelope&gt; readProposalsEnvelope(CBORMetadataList proposalsNode,
                                                                boolean isGdprProtection) {
<span class="nc" id="L477">        var proposals = new ArrayList&lt;ProposalEnvelope&gt;();</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">        for (int i = 0; i &lt; proposalsNode.size(); i++) {</span>
<span class="nc" id="L480">            var proposalCborMap = (CBORMetadataMap) proposalsNode.getValueAt(i);</span>

<span class="nc" id="L482">            var proposalEnvelopeBuilder = ProposalEnvelope.builder()</span>
<span class="nc" id="L483">                    .id((String) proposalCborMap.get(&quot;id&quot;));</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">            if (!isGdprProtection) {</span>
<span class="nc" id="L486">                proposalEnvelopeBuilder.name((String) proposalCborMap.get(&quot;name&quot;));</span>
            }

<span class="nc" id="L489">            proposals.add(proposalEnvelopeBuilder.build());</span>
        }

<span class="nc" id="L492">        return proposals;</span>
    }

    private static HydraTallyRegistrationEnvelope readHydraTallyEnvelope(CBORMetadataMap hydraConfigNode) {
<span class="nc" id="L496">        var compiledScriptM = deChunk(hydraConfigNode.get(&quot;compiledScript&quot;));</span>

<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (compiledScriptM.isEmpty()) {</span>
<span class="nc" id="L499">            throw new RuntimeException(&quot;Invalid hydra tally config. Missing compiledScript field&quot;);</span>
        }

<span class="nc" id="L502">        var compiledScript = compiledScriptM.orElseThrow();</span>

<span class="nc" id="L504">        var hydraTallyRegistrationEnvelopeBuilder = HydraTallyRegistrationEnvelope.builder()</span>
<span class="nc" id="L505">                .contractName(deChunk(hydraConfigNode.get(&quot;contractName&quot;)).orElseThrow())</span>
<span class="nc" id="L506">                .contractDesc(deChunk((hydraConfigNode.get(&quot;contractDesc&quot;))).orElseThrow())</span>
<span class="nc" id="L507">                .contractVersion((String) hydraConfigNode.get(&quot;contractVersion&quot;))</span>
<span class="nc" id="L508">                .plutusVersion((String) hydraConfigNode.get(&quot;plutusVersion&quot;))</span>
<span class="nc" id="L509">                .compiledScript(compiledScript)</span>
<span class="nc" id="L510">                .compiledScriptHash((String) hydraConfigNode.get(&quot;compiledScriptHash&quot;))</span>
<span class="nc" id="L511">                .compilerName((String) hydraConfigNode.get(&quot;compilerName&quot;))</span>
<span class="nc" id="L512">                .compilerVersion((String) hydraConfigNode.get(&quot;compilerVersion&quot;))</span>
                ;

<span class="nc" id="L515">        var verificationKeys = (CBORMetadataList) hydraConfigNode.get(&quot;verificationKeys&quot;);</span>

<span class="nc" id="L517">        hydraTallyRegistrationEnvelopeBuilder.verificationKeys(readVerificationKeys(verificationKeys));</span>

<span class="nc" id="L519">        return hydraTallyRegistrationEnvelopeBuilder.build();</span>
    }

    private static List&lt;String&gt; readVerificationKeys(CBORMetadataList cborMetadataList) {
<span class="nc" id="L523">        var verificationKeys = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L525" title="All 2 branches missed.">        for (int i = 0; i &lt; cborMetadataList.size(); i++) {</span>
<span class="nc" id="L526">            var verificationKey = deChunk(cborMetadataList.getValueAt(i)).orElseThrow();</span>
<span class="nc" id="L527">            verificationKeys.add(verificationKey);</span>
        }

<span class="nc" id="L530">        return verificationKeys;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>